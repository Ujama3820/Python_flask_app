name: CI/CD with Blue-Green on Minikube

on:
  push:
    branches: [ master ]

jobs:
  blue-green-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸ³ Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube

    - name: ğŸš€ Start Minikube
      run: |
        minikube start --driver=docker
        minikube status

    - name: ğŸ³ Use Minikube Docker Daemon
      run: |
        eval $(minikube docker-env)
        docker info

    - name: ğŸ› ï¸ Build Docker Image in Minikube
      run: |
        eval $(minikube docker-env)
        docker build -t flask-app-green:latest .

    - name: ğŸ“„ Deploy GREEN App
      run: |
        kubectl apply -f k8s-green-deployment.yaml

    - name: ğŸ” Health Check on GREEN
      run: |
        GREEN_URL=$(minikube service flask-app-green --url | head -n1)
        sleep 5
        curl -f $GREEN_URL/health || exit 1

    - name: ğŸ” Delete OLD BLUE Deployment
      run: |
        kubectl delete deployment flask-app-blue --ignore-not-found
        kubectl delete service flask-app-blue --ignore-not-found

    - name: âœ… Promote GREEN to BLUE
      run: |
        sed 's/flask-app-green/flask-app-blue/g' k8s-green-deployment.yaml | kubectl apply -f -
        kubectl rollout status deployment/flask-app-blue

    - name: âœ… Final Check
      run: |
        kubectl get deployments
        kubectl get services
