name: CI-CD with Minikube

on:
  push:
    branches: [ master ]

jobs:
  minikube-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸ“¦ Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube

    - name: ğŸ§± Start Minikube
      run: |
        minikube start --driver=docker
        minikube status

    - name: ğŸ³ Use Minikube Docker Daemon
      run: |
        eval $(minikube docker-env)
        docker info

    - name: ğŸ“¦ Build Docker Image inside Minikube
      run: |
        eval $(minikube docker-env)
        docker build -t flask-app:latest .

    - name: ğŸ“„ Deploy to Kubernetes
      run: |
        kubectl apply -f k8s-deployment.yaml
        kubectl rollout status deployment/flask-app

    - name: âœ… Verify Deployment
      run: |
        kubectl get pods
        kubectl get svc
